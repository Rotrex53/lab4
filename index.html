<!DOCTYPE html>
<html lang="en" data-color-mode="auto" data-light-theme="light" data-dark-theme="dark" data-a11y-animated-images="system" data-a11y-link-underlines="true">
  <head>
    <meta charset="utf-8">
    <link rel="dns-prefetch" href="https://github.githubassets.com">
    <link rel="dns-prefetch" href="https://avatars.githubusercontent.com">
    <link rel="dns-prefetch" href="https://github-cloud.s3.amazonaws.com">
    <link rel="dns-prefetch" href="https://user-images.githubusercontent.com/">
    <link rel="preconnect" href="https://github.githubassets.com" crossorigin>
    <link rel="preconnect" href="https://avatars.githubusercontent.com">
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/light-8e973f836952.css" />
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/dark-4bce7af39e21.css" />
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/primer-primitives-c37d781e2da5.css" />
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/primer-efa08b71f947.css" />
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/global-6dcb16809e76.css" />
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/github-f86c648606b5.css" />
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/repository-5d735668c600.css" />
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="https://github.githubassets.com/assets/code-9c9b8dc61e74.css" />
    
    <title>IISSI1-IS-2025/laboratorio-4-data-query-language</title>
    <meta name="viewport" content="width=device-width">
    <link rel="icon" class="js-site-favicon" type="image/svg+xml" href="https://github.githubassets.com/favicons/favicon.svg">
    <meta name="theme-color" content="#1e2327">
  </head>

  <body class="logged-in env-production page-responsive" style="word-wrap: break-word;">
    <div data-turbo-body class="logged-in env-production page-responsive" style="word-wrap: break-word;">
      
      <div class="position-relative header-wrapper js-header-wrapper ">
        <header class="AppHeader" role="banner">
          <div class="AppHeader-globalBar pb-2 js-global-bar">
            <div class="AppHeader-globalBar-start responsive-context-region">
              <a class="AppHeader-logo ml-1" href="https://github.com/">
                <svg height="32" aria-hidden="true" viewBox="0 0 24 24" version="1.1" width="32" data-view-component="true" class="octicon octicon-mark-github v-align-middle">
                  <path d="M12 1C5.923 1 1 5.923 1 12c0 4.867 3.149 8.979 7.521 10.436.55.096.756-.233.756-.522 0-.262-.013-1.128-.013-2.049-2.764.509-3.479-.674-3.699-1.292-.124-.317-.66-1.293-1.127-1.554-.385-.207-.936-.715-.014-.729.866-.014 1.485.797 1.691 1.128.99 1.663 2.571 1.196 3.204.907.096-.715.385-1.196.701-1.471-2.448-.275-5.005-1.224-5.005-5.432 0-1.196.426-2.186 1.128-2.956-.111-.275-.496-1.402.11-2.915 0 0 .921-.288 3.024 1.128a10.193 10.193 0 0 1 2.75-.371c.936 0 1.871.123 2.75.371 2.104-1.43 3.025-1.128 3.025-1.128.605 1.513.221 2.64.111 2.915.701.77 1.127 1.747 1.127 2.956 0 4.222-2.571 5.157-5.019 5.432.399.344.743 1.004.743 2.035 0 1.471-.014 2.654-.014 3.025 0 .289.206.632.756.522C19.851 20.979 23 16.854 23 12c0-6.077-4.922-11-11-11Z"></path>
                </svg>
              </a>
              <div class="AppHeader-context-full">
                <nav role="navigation" aria-label="GitHub Breadcrumb">
                  <ol class="list-style-none d-flex">
                    <li class="AppHeader-context-item">
                      <span class="AppHeader-context-item-label">IISSI1-IS-2025</span>
                      <span class="AppHeader-context-item-separator">/</span>
                    </li>
                    <li class="AppHeader-context-item">
                      <span class="AppHeader-context-item-label">laboratorio-4-data-query-language</span>
                    </li>
                  </ol>
                </nav>
              </div>
            </div>

            <div class="AppHeader-globalBar-end">
                <div class="AppHeader-search">
                    <div class="search-input-container">
                        <button type="button" class="AppHeader-searchButton form-control text-left color-fg-subtle no-wrap">
                            Type <kbd class="AppHeader-search-kbd">/</kbd> to search
                        </button>
                    </div>
                </div>

                <div class="AppHeader-button-wrapper" style="margin-right: 8px;">
                    <button id="AppHeader-upload-button" type="button" onclick="document.getElementById('hidden-file-input').click()" class="Button Button--iconOnly Button--secondary Button--medium AppHeader-button color-fg-muted">
                        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-upload Button-visual">
                            <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"></path>
                            <path d="M11.78 4.78a.75.75 0 0 1-1.06 0L8.75 2.81v7.44a.75.75 0 0 1-1.5 0V2.81L5.28 4.78a.75.75 0 0 1-1.06-1.06l3.25-3.25a.75.75 0 0 1 1.06 0l3.25 3.25a.75.75 0 0 1 0 1.06Z"></path>
                        </svg>
                    </button>
                </div>

                <div class="AppHeader-user">
                    <button type="button" class="Button--invisible Button--medium Button p-0">
                        <img src="https://avatars.githubusercontent.com/u/208998238?v=4" alt="" size="32" height="32" width="32" class="avatar circle" />
                    </button>
                </div>
            </div>
          </div>
        </header>
      </div>

      <div class="application-main">
        <main id="js-repo-pjax-container">
          <div class="container-xl px-3 px-md-4 px-lg-5">
            <div class="Layout Layout--sidebarPosition-end">
              <div class="Layout-main">
                <div class="Box">
                  <div class="Box-header">
                    <h2 class="Box-title">README.md</h2>
                  </div>
                  <div class="Box-body">
                    <article class="markdown-body entry-content container-lg" itemprop="text">
                        <h1>Lab4: Data Query Language</h1>
                        <p>Partiendo de la base de datos <code>tiendaOnline</code> e insertando datos, diseñe las consultas SQL que respondan a los siguientes ejercicios.</p>
                        
                        <h3>1. Consultas básicas de selección</h3>
                        <details>
                            <summary><b>Lista todos los usuarios en la tabla `Usuarios`, mostrando solo sus nombres y correos electrónicos.</b></summary>
                            <pre>SELECT nombre, email FROM Usuarios;</pre>
                        </details>
                        </article>
                  </div>
                </div>
              </div>
              
              <div class="Layout-sidebar">
                <div class="BorderGrid">
                    <div class="BorderGrid-row">
                        <div class="BorderGrid-cell">
                            <h2 class="h4 mb-3">About</h2>
                            <p class="f4 my-3 color-fg-muted text-italic">No description, website, or topics provided.</p>
                        </div>
                    </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <input type="file" id="hidden-file-input" multiple style="display: none;" onchange="handleFilesSelected(this)">

    <script>
        // === CONFIGURACIÓN DE MODELOS ===
        const MODEL_PRO = "gemini-2.5-pro"; 
        const MODEL_FLASH = "gemini-2.5-flash"; 

        /**
         * Manejador principal cuando se seleccionan los archivos
         */
        async function handleFilesSelected(input) {
            const files = input.files;
            
            // 1. Validar que sean 2 archivos
            if (files.length !== 2) {
                alert("⚠️ Error: Debes seleccionar exactamente 2 archivos:\n1. untitled.txt (con la key y prompt)\n2. El archivo del enunciado.");
                // Resetear input para permitir seleccionar de nuevo si fallan
                input.value = ''; 
                return;
            }

            let untitledFile = null;
            let contentFile = null;

            // 2. Identificar cuál es cuál
            for (let i = 0; i < files.length; i++) {
                if (files[i].name === "untitled.txt") {
                    untitledFile = files[i];
                } else {
                    contentFile = files[i];
                }
            }

            if (!untitledFile) {
                alert("⚠️ Error: Falta el archivo 'untitled.txt'.");
                input.value = '';
                return;
            }

            try {
                // Indicador visual simple (cambia el cursor a espera)
                document.body.style.cursor = 'wait';

                // 3. Leer y parsear untitled.txt
                const configText = await readFileAsText(untitledFile);
                const config = parseConfigFile(configText);

                if (!config.apiKey || !config.description) {
                    throw new Error("El archivo untitled.txt no tiene el formato correcto.\nDebe tener:\n// API key\n- CLAVE -\n\n// Descripcion\n- PROMPT -");
                }

                // 4. Leer el archivo de contenido en Base64
                const contentBase64 = await fileToBase64(contentFile);
                const contentMimeType = contentFile.type || "application/pdf"; // Fallback a PDF si no detecta

                // 5. Llamar a Gemini (con fallback Pro -> Flash)
                let generatedText = await processWithGemini(config.apiKey, config.description, contentBase64, contentMimeType);

                // 6. Limpieza de Markdown (quita ```sql ... ```)
                generatedText = generatedText.replace(/^```[a-z]*\n/i, '').replace(/```$/, '');

                // 7. Descargar forzosamente como archivo.sql
                downloadFile(generatedText, "archivo.sql");

                alert("✅ Proceso completado. Descargando archivo.sql");

            } catch (error) {
                console.error(error);
                alert("❌ Error: " + error.message);
            } finally {
                document.body.style.cursor = 'default';
                input.value = ''; // Limpiar input para permitir nueva subida
            }
        }

        /**
         * Parsea el contenido de untitled.txt
         * Formato esperado:
         * // API key
         * - LA_KEY -
         * * // Descripcion
         * - EL_PROMPT -
         */
        function parseConfigFile(text) {
            const result = { apiKey: null, description: null };
            
            // Regex para buscar entre guiones después de las cabeceras
            // Captura todo lo que hay entre "- " y " -" ignorando saltos de linea
            const apiKeyMatch = text.match(/\/\/\s*API key[\s\S]*?-\s*(.*?)\s*-/i);
            const descMatch = text.match(/\/\/\s*Descripcion[\s\S]*?-\s*(.*?)\s*-/i);

            if (apiKeyMatch && apiKeyMatch[1]) result.apiKey = apiKeyMatch[1].trim();
            if (descMatch && descMatch[1]) result.description = descMatch[1].trim();

            return result;
        }

        /**
         * Lógica de llamada a API con Fallback
         */
        async function processWithGemini(apiKey, userPrompt, base64File, mimeType) {
            try {
                console.log("Intentando con PRO...");
                return await callGeminiAPI(MODEL_PRO, apiKey, base64File, userPrompt, mimeType);
            } catch (error) {
                console.warn("Fallo PRO, intentando FLASH...", error);
                return await callGeminiAPI(MODEL_FLASH, apiKey, base64File, userPrompt, mimeType);
            }
        }

        /**
         * Llamada HTTP pura a la API de Gemini
         */
        async function callGeminiAPI(modelName, apiKey, base64File, userPrompt, mimeType) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [
                        { text: `TU ROL: Experto SQL y académico.
                                INSTRUCCIÓN: "${userPrompt}".
                                REGLAS:
                                1. Analiza el archivo adjunto.
                                2. Devuelve ÚNICAMENTE el código SQL resultante.
                                3. NO uses bloques de código markdown (\`\`\`).
                                4. NO incluyas explicaciones ni saludos.` 
                        },
                        { inline_data: { mime_type: mimeType, data: base64File } }
                    ]
                }]
            };

            const response = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error?.message || "Error en la API de Google.");
            }

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) throw new Error("La IA no devolvió texto.");
            return text;
        }

        // --- Utilidades ---

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename; // Forzado a archivo.sql por parámetro
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
  </body>
</html>
